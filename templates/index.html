<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Habits Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%); color: #e2e8f0; min-height: 100vh; }
        .wrapper { display: grid; grid-template-columns: 200px 1fr; min-height: 100vh; }
        .sidebar { background: #0f172a; border-right: 1px solid #334155; padding: 1.5rem 1rem; }
        .logo { font-size: 1rem; font-weight: 700; color: #3b82f6; margin-bottom: 2rem; }
        .nav { display: flex; flex-direction: column; gap: 0.5rem; }
        .nav button { padding: 0.75rem 1rem; background: none; border: none; color: #94a3b8; cursor: pointer; text-align: left; border-radius: 0.375rem; }
        .nav button.active { background: #3b82f6; color: white; }
        .main { padding: 2rem; overflow-y: auto; }
        .header { margin-bottom: 1.5rem; }
        .title { font-size: 1.8rem; font-weight: 700; }
        .quote-box { background: linear-gradient(135deg, #3b82f6 0%, #1e40af 100%); border-radius: 0.75rem; padding: 1.5rem; text-align: center; margin-bottom: 2rem; }
        .quote-text { font-size: 1.1rem; font-weight: 500; margin-bottom: 0.5rem; }
        .quote-author { font-size: 0.9rem; opacity: 0.9; font-style: italic; }
        .top { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem; }
        .card { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; }
        .card h3 { margin-bottom: 1.25rem; font-size: 1rem; }
        .task-input { width: 100%; background: #0f172a; border: 1px solid #475569; color: #e2e8f0; padding: 0.75rem; border-radius: 0.375rem; margin-bottom: 1rem; }
        .colors { display: flex; gap: 0.75rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .color { width: 2.25rem; height: 2.25rem; border-radius: 50%; border: 3px solid transparent; cursor: pointer; transition: all 0.2s; }
        .color.active { border-color: white; transform: scale(1.15); }
        .btn-add { width: 100%; background: #16a34a; color: white; border: none; padding: 0.75rem; border-radius: 0.375rem; cursor: pointer; font-weight: 600; }
        .btn-add:hover { background: #15803d; }
        .charts-box { height: 300px; display: flex; gap: 1.5rem; }
        .chart { flex: 1; position: relative; }
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
        .stat { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 1.5rem; text-align: center; }
        .stat-num { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; }
        .stat-name { font-size: 0.9rem; color: #94a3b8; }
        .table-box { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; overflow: auto; }
        table { width: 100%; border-collapse: collapse; }
        thead { background: #0f172a; }
        th { padding: 1rem; text-align: left; font-weight: 600; border-bottom: 1px solid #334155; font-size: 0.9rem; }
        td { padding: 1rem; border-bottom: 1px solid #334155; }
        tbody tr:hover { background: rgba(71, 85, 105, 0.1); }
        .task-name { display: flex; align-items: center; gap: 0.75rem; }
        .dot { width: 0.75rem; height: 0.75rem; border-radius: 0.15rem; }
        .check { width: 1.75rem; height: 1.75rem; border: none; background: #334155; color: #94a3b8; border-radius: 0.25rem; cursor: pointer; font-weight: 600; transition: all 0.2s; }
        .check:hover { transform: scale(1.05); }
        .check.done { color: white; }
        .check:disabled { cursor: not-allowed; opacity: 0.5; }
        .del-btn { background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1rem; }
        .footer { text-align: center; padding: 2rem; color: #64748b; border-top: 1px solid #334155; margin-top: 2rem; }
        .footer a { color: #3b82f6; text-decoration: none; }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 1000; display: none; align-items: center; justify-content: center; }
        .modal.show { display: flex !important; }
        .modal-box { background: #1e293b; border: 1px solid #334155; border-radius: 0.75rem; padding: 2rem; min-width: 350px; }
        .modal-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
        .modal-text { color: #94a3b8; margin-bottom: 1.5rem; }
        .modal-buttons { display: flex; gap: 1rem; justify-content: flex-end; }
        .modal-btn { padding: 0.75rem 1.5rem; border: none; border-radius: 0.375rem; cursor: pointer; font-weight: 600; }
        .btn-cancel { background: #334155; color: #e2e8f0; }
        .btn-delete { background: #ef4444; color: white; }
        .toast { position: fixed; bottom: 2rem; right: 2rem; background: #16a34a; color: white; padding: 1rem 1.5rem; border-radius: 0.5rem; z-index: 2000; }
    </style>
</head>
<body>
    <div class="wrapper">
        <aside class="sidebar">
            <div class="logo">üìä Habit Tracker</div>
            <nav class="nav">
                <button class="active" disabled>Dashboard</button>
            </nav>
        </aside>

        <main class="main">
            <div class="header">
                <div class="title">üöÄ Daily Habits</div>
            </div>

            <div class="quote-box" id="quote">
                <div class="quote-text">Loading inspiration...</div>
            </div>

            <div class="top">
                <div class="card">
                    <h3>‚ûï Add New Task</h3>
                    <input type="text" class="task-input" id="taskName" placeholder="Task name...">
                    <div class="colors" id="colorPicker"></div>
                    <button type="button" class="btn-add" onclick="openModal()">Add Task</button>
                </div>

                <div class="card">
                    <h3>üìä Your Progress</h3>
                    <div class="charts-box">
                        <div class="chart"><canvas id="line"></canvas></div>
                        <div class="chart"><canvas id="pie"></canvas></div>
                    </div>
                </div>
            </div>

            <div class="stats" id="stats"></div>

            <div class="table-box">
                <table>
                    <thead id="thead"></thead>
                    <tbody id="tbody"></tbody>
                </table>
            </div>

            <div class="footer">
                <p>Project by <strong>Krithick Kumar Sivakumar</strong></p>
                <p>üìß <a href="mailto:krithickkumarsivakumar@gmail.com">krithickkumarsivakumar@gmail.com</a></p>
            </div>
        </main>
    </div>

    <div class="modal" id="modal">
        <div class="modal-box">
            <div class="modal-title">Set Task Duration</div>
            <div class="modal-text">Choose date range:</div>
            <div style="display: flex; flex-direction: column; gap: 1rem; margin-bottom: 1.5rem;">
                <div>
                    <label style="color: #94a3b8;">From:</label>
                    <input type="date" id="startDate" style="width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #475569; color: #e2e8f0; border-radius: 0.375rem; margin-top: 0.5rem;">
                </div>
                <div>
                    <label style="color: #94a3b8;">To:</label>
                    <input type="date" id="endDate" style="width: 100%; padding: 0.75rem; background: #0f172a; border: 1px solid #475569; color: #e2e8f0; border-radius: 0.375rem; margin-top: 0.5rem;">
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-cancel" onclick="closeModal()">Cancel</button>
                <button type="button" class="modal-btn" style="background: #16a34a; color: white;" onclick="addTask()">Add Task</button>
            </div>
        </div>
    </div>

    <div class="modal" id="deleteModal">
        <div class="modal-box">
            <div class="modal-title">Delete Task?</div>
            <div class="modal-text">This cannot be undone.</div>
            <div class="modal-buttons">
                <button type="button" class="modal-btn btn-cancel" onclick="closeDelete()">Cancel</button>
                <button type="button" class="modal-btn btn-delete" onclick="confirmDelete()">Delete</button>
            </div>
        </div>
    </div>

    <script>
        const COLORS = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#95E1D3', '#FFA07A', '#FFD93D', '#6BCB77', '#A78BFA'];
        let selectedColor = COLORS[0];
        let tasks = [];
        let completions = {};
        let deleteId = null;
        let taskDurations = {};

        document.addEventListener('DOMContentLoaded', () => {
            renderColors();
            loadAll();
            loadQuote();
        });

        function renderColors() {
            const box = document.getElementById('colorPicker');
            COLORS.forEach(c => {
                const btn = document.createElement('button');
                btn.className = 'color' + (c === selectedColor ? ' active' : '');
                btn.style.backgroundColor = c;
                btn.type = 'button';
                btn.onclick = () => {
                    document.querySelectorAll('.color').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    selectedColor = c;
                };
                box.appendChild(btn);
            });
        }

        function loadQuote() {
            const quotes = [
                { text: "Success is the sum of small efforts repeated day in and day out.", author: "Robert Collier" },
                { text: "The only way to do great work is to love what you do.", author: "Steve Jobs" },
                { text: "Believe in yourself. You are braver than you believe.", author: "A.A. Milne" },
                { text: "Don't watch the clock; do what it does. Keep going.", author: "Sam Levenson" }
            ];
            const q = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('quote').innerHTML = `<div class="quote-text">"${q.text}"</div><div class="quote-author">‚Äî ${q.author}</div>`;
        }

        async function loadAll() {
            try {
                const t1 = await fetch('/api/tasks');
                tasks = await t1.json();
                const t2 = await fetch('/api/completions');
                completions = await t2.json();
                const t3 = await fetch('/api/task-durations');
                const durData = await t3.json();
                taskDurations = durData;
                console.log('Tasks:', tasks);
                console.log('Completions:', completions);
                console.log('Task Durations:', taskDurations);
                render();
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function render() {
            renderTable();
            renderStats();
            renderCharts();
        }

        function openModal() {
            const name = document.getElementById('taskName').value.trim();
            if (!name) return alert('Enter task name');
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            document.getElementById('modal').classList.add('show');
        }

        function closeModal() {
            document.getElementById('modal').classList.remove('show');
        }

        async function addTask() {
            const name = document.getElementById('taskName').value.trim();
            const start = document.getElementById('startDate').value;
            const end = document.getElementById('endDate').value;
            if (!start || !end) return alert('Pick both dates');
            const s = new Date(start);
            const e = new Date(end);
            if (s > e) return alert('Start before end');
            const days = Math.ceil((e-s)/(1000*60*60*24))+1;
            
            try {
                const res = await fetch('/api/tasks', {
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body:JSON.stringify({name, color:selectedColor, duration:days, start_date:start, end_date:end})
                });
                
                if (res.ok) {
                    const task = await res.json();
                    taskDurations[task.id] = {start_date:start, end_date:end, duration:days};
                    document.getElementById('taskName').value = '';
                    closeModal();
                    loadAll();
                    toast('‚úÖ Task added!');
                } else {
                    alert('Error adding task');
                }
            } catch (error) {
                console.error('Error adding task:', error);
                alert('Error adding task');
            }
        }

        function toast(msg) {
            const el = document.createElement('div');
            el.className = 'toast';
            el.textContent = msg;
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 3000);
        }

        function openDelete(id) {
            deleteId = id;
            document.getElementById('deleteModal').classList.add('show');
        }

        function closeDelete() {
            document.getElementById('deleteModal').classList.remove('show');
        }

        async function confirmDelete() {
            try {
                await fetch(`/api/tasks/${deleteId}`, {method:'DELETE'});
                closeDelete();
                loadAll();
                toast('Deleted!');
            } catch (error) {
                console.error('Error deleting task:', error);
            }
        }

        function getDays(taskId) {
            const days = [];
            let start = new Date(), end = new Date();
            if (taskId && taskDurations && taskDurations[taskId]) {
                start = new Date(taskDurations[taskId].start_date + 'T00:00:00');
                end = new Date(taskDurations[taskId].end_date + 'T00:00:00');
            } else {
                start.setDate(start.getDate() - 29);
            }
            const cur = new Date(start);
            while (cur <= end) {
                days.push(new Date(cur));
                cur.setDate(cur.getDate() + 1);
            }
            return days;
        }

        function renderTable() {
            if (!tasks.length) {
                document.getElementById('thead').innerHTML = '<tr><th>Habit</th><th>Progress</th></tr>';
                document.getElementById('tbody').innerHTML = '<tr><td colspan="35">No tasks</td></tr>';
                return;
            }
            
            // Find the task with the earliest start date and longest range
            let earliestDate = new Date();
            let longestTaskId = tasks[0].id;
            let longestDuration = 0;
            
            tasks.forEach(t => {
                const dur = taskDurations[t.id]?.duration || 30;
                const startStr = taskDurations[t.id]?.start_date;
                if (startStr) {
                    const startDate = new Date(startStr + 'T00:00:00');
                    if (startDate < earliestDate) {
                        earliestDate = startDate;
                    }
                }
                if (dur > longestDuration) {
                    longestDuration = dur;
                    longestTaskId = t.id;
                }
            });
            
            // Get header days starting from earliest date
            let headerDays = [];
            let cur = new Date(earliestDate);
            for (let i = 0; i < longestDuration; i++) {
                headerDays.push(new Date(cur));
                cur.setDate(cur.getDate() + 1);
            }
            
            if (!headerDays.length) return;
            
            // Build header
            let head = '<tr><th>Habit</th><th style="text-align:center">Progress</th>';
            headerDays.forEach(d => {
                const date = d.getDate();
                const week = d.toLocaleDateString('en-US',{weekday:'short'}).charAt(0);
                const month = d.toLocaleDateString('en-US',{month:'short'});
                head += `<th style="text-align:center;font-size:0.8rem"><strong>${date}</strong><br>${week}<br><span style="color:#64748b">${month}</span></th>`;
            });
            head += '<th></th></tr>';
            document.getElementById('thead').innerHTML = head;
            
            let body = '';
            const today = new Date();
            today.setHours(0,0,0,0);
            
            tasks.forEach(t => {
                const startStr = taskDurations[t.id]?.start_date;
                const startDate = startStr ? new Date(startStr + 'T00:00:00') : new Date(earliestDate);
                const taskDays = getDays(t.id);
                const done = Object.entries(completions).filter(([k,v]) => k.startsWith(t.id+'-') && v).length;
                const dur = taskDurations[t.id]?.duration || 30;
                
                // Calculate offset: how many days from earliest date to this task's start
                const offset = Math.floor((startDate - earliestDate) / (1000*60*60*24));
                
                body += `<tr><td><div class="task-name"><div class="dot" style="background:${t.color}"></div>${t.name}</div></td><td style="text-align:center;font-weight:600">${done}/${dur}</td>`;
                
                // Show checkboxes aligned to correct dates
                for (let i = 0; i < headerDays.length; i++) {
                    const dayIndex = i - offset; // Which day within this task
                    
                    if (dayIndex >= 0 && dayIndex < taskDays.length) {
                        const key = t.id+'-'+dayIndex;
                        const checked = completions[key];
                        const isFuture = new Date(headerDays[i]) > today;
                        const bgStyle = checked ? `background:${t.color};` : '';
                        if (isFuture) {
                            body += `<td style="text-align:center"><button class="check${checked?' done':''}" style="${bgStyle}opacity:0.5;" disabled>${checked?'‚úì':'‚óã'}</button></td>`;
                        } else {
                            body += `<td style="text-align:center"><button class="check${checked?' done':''}" style="${bgStyle}" onclick="window.toggleDay('${t.id}',${dayIndex})">${checked?'‚úì':'‚óã'}</button></td>`;
                        }
                    } else {
                        // Day is outside this task's range
                        body += `<td style="text-align:center">-</td>`;
                    }
                }
                body += `<td><button class="del-btn" onclick="openDelete('${t.id}')">üóëÔ∏è</button></td></tr>`;
            });
            document.getElementById('tbody').innerHTML = body;
        }

        window.toggleDay = async function(taskId, dayIndex) {
            console.log(`Toggling ${taskId} - Day ${dayIndex}`);
            try {
                const res = await fetch(`/api/completions/${taskId}/${dayIndex}`, {method:'POST'});
                if (res.ok) {
                    console.log('Toggle successful');
                    await loadAll();
                } else {
                    console.error('Toggle failed:', res.status);
                    alert('Error marking day');
                }
            } catch (error) {
                console.error('Error toggling day:', error);
                alert('Error marking day');
            }
        }

        function renderStats() {
            let html = '';
            tasks.forEach(t => {
                const done = Object.entries(completions).filter(([k,v]) => k.startsWith(t.id+'-') && v).length;
                const dur = taskDurations[t.id]?.duration || 30;
                const pct = ((done/dur)*100).toFixed(2); // ‚úÖ 2 decimal places
                html += `<div class="stat"><div class="stat-num" style="color:${t.color}">${pct}%</div><div class="stat-name">${t.name}</div></div>`;
            });
            document.getElementById('stats').innerHTML = html || '<p>Add tasks</p>';
        }

        function renderCharts() {
            if (!tasks.length) return;
            const barLabels = tasks.map(t => t.name);
            const barData = tasks.map(t => {
                const done = Object.entries(completions).filter(([k,v]) => k.startsWith(t.id+'-') && v).length;
                const dur = taskDurations[t.id]?.duration || 30;
                return parseFloat(((done/dur)*100).toFixed(2)); // ‚úÖ Decimal
            });
            if (window.barChart) window.barChart.destroy();
            window.barChart = new Chart(document.getElementById('line'), {
                type:'bar',data:{labels:barLabels,datasets:[{label:'%',data:barData,backgroundColor:tasks.map(t=>t.color),borderColor:tasks.map(t=>t.color),borderWidth:2,borderRadius:8,barThickness:40}]},
                options:{indexAxis:'y',responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,max:100,ticks:{color:'#64748b',callback:v=>v+'%'},grid:{color:'rgba(148,163,184,0.15)'}},y:{ticks:{color:'#94a3b8'},grid:{display:false}}}}
            });
            const pieLabels = tasks.map(t => t.name);
            const pieData = tasks.map(t => {
                const done = Object.entries(completions).filter(([k,v]) => k.startsWith(t.id+'-') && v).length;
                const dur = taskDurations[t.id]?.duration || 30;
                return parseFloat(((done/dur)*100).toFixed(2)); // ‚úÖ Decimal
            });
            if (window.pieChart) window.pieChart.destroy();
            window.pieChart = new Chart(document.getElementById('pie'), {
                type:'pie',data:{labels:pieLabels,datasets:[{data:pieData,backgroundColor:tasks.map(t=>t.color),borderColor:'#0f172a',borderWidth:3}]},
                options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{labels:{color:'#94a3b8',font:{size:11,weight:'600'},padding:20},position:'right'}}}
            });
        }
    </script>
</body>
</html>
